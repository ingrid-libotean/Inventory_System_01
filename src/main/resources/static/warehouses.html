<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Warehouses</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="p-4 bg-light">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üè≠ My Warehouses</h2>
        <a href="dashboard.html" class="btn btn-secondary">Back to Dashboard</a>
    </div>

    <div class="card mb-4 p-3 shadow-sm">
        <h5>Add New Warehouse</h5>
        <div class="input-group">
            <input type="text" id="whName" class="form-control" placeholder="Warehouse Name (e.g., Garage)">
            <input type="text" id="whLocation" class="form-control" placeholder="Location (e.g., Home)">
            <button class="btn btn-primary" onclick="addWarehouse()">+ Add</button>
        </div>
    </div>

    <div class="row" id="warehouseList">
        <p class="text-center text-muted">Loading warehouses...</p>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Warehouse</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editId">
                <div class="mb-3">
                    <label>Name</label>
                    <input type="text" id="editName" class="form-control">
                </div>
                <div class="mb-3">
                    <label>Location</label>
                    <input type="text" id="editLocation" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<script>
    const userEmail = sessionStorage.getItem("userEmail");
    if (!userEmail) window.location.href = "index.html";

    const API_URL = "http://localhost:8080/api/warehouses";
    let editModal; // Variabila pentru controlul ferestrei

    // Initializare
    document.addEventListener("DOMContentLoaded", function() {
        editModal = new bootstrap.Modal(document.getElementById('editModal'));
        loadWarehouses();
    });

    // 1. READ (Load)
    async function loadWarehouses() {
        const response = await fetch(`${API_URL}/user/${userEmail}`);
        const warehouses = await response.json();

        const listDiv = document.getElementById("warehouseList");
        listDiv.innerHTML = "";

        if (warehouses.length === 0) {
            listDiv.innerHTML = "<p class='text-center'>No warehouses found.</p>";
            return;
        }

        warehouses.forEach(wh => {
            const card = `
                <div class="col-md-4 mb-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h5 class="card-title">${wh.name}</h5>
                                <small class="text-muted">ID: ${wh.warehouse_id}</small>
                            </div>
                            <p class="card-text text-muted">üìç ${wh.location}</p>

                            <div class="mt-3 d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary flex-grow-1"
    onclick="location.href='items.html?id=${wh.warehouse_id}&name=${wh.name}'">
    View Items
</button>
                                <button class="btn btn-sm btn-warning" onclick="openEdit('${wh.warehouse_id}', '${wh.name}', '${wh.location}')">‚úèÔ∏è</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteWarehouse('${wh.warehouse_id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            listDiv.innerHTML += card;
        });
    }

    // 2. CREATE (Add)
    async function addWarehouse() {
        const name = document.getElementById("whName").value;
        const loc = document.getElementById("whLocation").value;
        if (!name) return alert("Please enter a name!");

        await fetch(`${API_URL}/add?email=${userEmail}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: name, location: loc })
        });

        document.getElementById("whName").value = "";
        document.getElementById("whLocation").value = "";
        loadWarehouses();
    }

    // 3. DELETE
    async function deleteWarehouse(id) {
        if (!confirm("Are you sure you want to delete this warehouse?")) return;

        await fetch(`${API_URL}/delete/${id}`, { method: "DELETE" });
        loadWarehouses();
    }

    // 4. UPDATE (Partea 1: Deschide fereastra)
    function openEdit(id, name, location) {
        document.getElementById("editId").value = id;
        document.getElementById("editName").value = name;
        document.getElementById("editLocation").value = location;
        editModal.show(); // AratƒÉ fereastra
    }

    // 4. UPDATE (Partea 2: SalveazƒÉ datele)
    async function saveEdit() {
        const id = document.getElementById("editId").value;
        const name = document.getElementById("editName").value;
        const loc = document.getElementById("editLocation").value;

        await fetch(`${API_URL}/update/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name: name, location: loc })
        });

        editModal.hide(); // Ascunde fereastra
        loadWarehouses(); // Re√ÆncarcƒÉ lista
    }
</script>

</body>
</html>