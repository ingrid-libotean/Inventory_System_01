<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-dark text-white">

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-danger">üõ°Ô∏è Admin Panel</h2>
        <a href="dashboard.html" class="btn btn-outline-light">Back to Dashboard</a>
    </div>

    <div class="card bg-secondary text-white shadow">
        <div class="card-header">
            All Registered Users
        </div>
        <div class="card-body p-0">
            <table class="table table-dark table-striped mb-0">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="usersTable">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Security Check simplu (Frontend level)
    const currentRole = sessionStorage.getItem("userRole");
    if (currentRole !== "ADMIN") {
        alert("ACCESS DENIED: Admins only!");
        window.location.href = "dashboard.html";
    }

    const API_URL = "http://localhost:8080/api/users";
    loadUsers();

    async function loadUsers() {
        const response = await fetch(`${API_URL}/all`);
        const users = await response.json();

        const tbody = document.getElementById("usersTable");
        tbody.innerHTML = "";

        users.forEach(user => {
            const isMe = (user.email === sessionStorage.getItem("userEmail"));
            const deleteBtn = isMe
                ? `<span class="badge bg-info">It's You</span>`
                : `<button class="btn btn-sm btn-danger" onclick="deleteUser(${user.user_id})">Delete</button>`;

            // Buton de promovare dacƒÉ e Client
            const promoteBtn = (user.role === "CLIENT")
                ? `<button class="btn btn-sm btn-warning ms-1" onclick="promote(${user.user_id})">Make Admin</button>`
                : "";

            const row = `
                <tr>
                    <td>${user.user_id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td><span class="badge ${user.role === 'ADMIN' ? 'bg-danger' : 'bg-primary'}">${user.role}</span></td>
                    <td>
                        ${deleteBtn}
                        ${promoteBtn}
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    async function deleteUser(id) {
        if(confirm("Are you sure? This will delete the user and their data.")) {
            await fetch(`${API_URL}/delete/${id}`, { method: "DELETE" });
            loadUsers();
        }
    }

    async function promote(id) {
        if(confirm("Promote this user to ADMIN?")) {
            await fetch(`${API_URL}/promote/${id}`, { method: "PUT" });
            loadUsers();
        }
    }
</script>

</body>
</html>